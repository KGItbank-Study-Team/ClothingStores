<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
 <mapper namespace="com.slimbear.mapper.Order">
		<!-- 주문(productOrder) -->
		<select id="SELECT_ORDER_LIST_BY_MEMBER_UID" resultType="order">
			SELECT * FROM productOrder WHERE
			<if test="status != null">
				status=#{status} AND
			</if>
			<if test="startDate != null">
				order_date>=#{startDate} AND
			</if>
			<if test="endDate != null">
				<![CDATA[
					order_date<=#{endDate} AND
				]]>
			</if>
			mem_uid=#{memberUID} ORDER BY order_date DESC
		</select>
		
		<select id="SELECT_ORDER_BY_UID" resultType="order">
			SELECT * FROM productOrder WHERE uid=#{orderUID}
		</select>
		
		<select id="SELECT_ORDER_TOTAL_CNTS_BY_LIST" resultType="java.util.HashMap">
			SELECT SUBSTRING_INDEX(prod_code,':',1) as prod_uid, count(*) as toc, SUM(cnt) as tpc 
			FROM orderDetail 
			WHERE prod_code 
			GROUP BY prod_uid;
		</select>
		
		<select id="SELECT_ORDER_BY_ORDER_UID" resultType="order">
			SELECT * FROM productOrder WHERE order_uid = #{order_uid}
		</select>
			
		
		<insert id="INSERT_ORDER" useGeneratedKeys="true" keyProperty="uid"> 
			INSERT INTO productOrder
			(mem_uid, order_date, status, total_price, code, deliv_price, addisale_price, use_mileage, order_request, deliv_recipient, deliv_address, deliv_tel, deliv_norm_tel)
			VALUES(#{mem_uid},#{order_date},#{status},#{total_price}, #{code}, #{deliv_price}, #{addisale_price}, #{use_mileage}, #{order_request}, #{deliv_recipient}, #{deliv_address}, #{deliv_tel}, #{deliv_norm_tel})
		</insert>
		
		<update id="UPDATE_ORDER">
			UPDATE productOrder
			SET member_uid=#{member_uid}, order_date=#{order_date}, status=#{status}, total_price=#{total_price}
			WHERE uid=#{uid}
		</update>
		
		<update id="UPDATE_ORDER_STATUS">
			UPDATE productOrder
			SET status=#{status}
			WHERE uid=#{uid}
		</update>

 		<!-- 주문상세(orderDetail) -->
		<select id="SELECT_ORDERDETAIL_LIST_BY_ORDER_UID" resultType="orderDetail" parameterType="order">
			SELECT * FROM orderDetail WHERE order_uid=#{uid}
		</select>
		
		<insert id="INSERT_ORDERDETAIL"> 
			INSERT INTO orderDetail
			(order_uid, prod_code, cnt, total_price)
			VALUES(#{order_uid},#{prod_code},#{cnt},#{total_price})
		</insert>

 		<!-- 주문결제(orderPayment) -->	
 		<select id="SELECT_PAYMENT_BY_ORDER_UID" resultType="orderPayment">
			SELECT * FROM orderPayment WHERE order_uid=#{orderUID}
		</select>
		
		<insert id="INSERT_PAYMENT"> 
			INSERT INTO orderPayment
			(order_uid, pay_date, type, status, price,pay_pg)
			VALUES(#{order_uid},#{pay_date},#{type},#{status},#{price},#{pay_pg})
		</insert>
		
		<update id="UPDATE_PAYMENT">
			UPDATE orderPayment
			SET pay_date=#{pay_date}, type=#{type}, status=#{status}, price=#{price}
			WHERE order_uid=#{order_uid}
		</update>
		
		<update id="UPDATE_PAYMENT_STATUS">
			UPDATE orderPayment
			SET status=#{status}
			WHERE order_uid=#{order_uid}
		</update>

 </mapper>