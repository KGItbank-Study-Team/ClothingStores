<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
 <mapper namespace="com.slimbear.mapper.Admin">
 
 	<!-- 관리자(admin) -->
 	<select id="SELECT_ADMIN_BY_ID" resultType="admin">
 		SELECT * FROM admin WHERE id=#{id}
 	</select>
 	
 	
 	<!-- 상품 전체 보기 -->
 	<select id="SELECT_PRODUCT_TOTAL_LIST" resultType="productTotalListItem" >
 		SELECT p.* , count(po.order_uid) as toc, if(po.order_uid is not null, SUM(cnt), 0) as tpc 
		FROM product p LEFT JOIN 
		orderDetail po ON(p.uid=SUBSTRING_INDEX(po.prod_code,':',1))
		GROUP BY p.uid
 	</select>
 	
 	<select id="SELECT_ORDER_LIST" resultType="com.kgitbank.slimbear.admin.dto.OrderListDTO">
 		SELECT m.id AS owner_id, o.*, p.status AS pay_status, p.pay_pg AS pay_pg, p.type AS pay_type, p.price AS pay_amount
		FROM productOrder o LEFT JOIN orderPayment p 
		ON(o.uid=p.order_uid)
		LEFT JOIN member m
		ON(o.mem_uid=m.uid);
 	</select>
 	
 	<select id="SELECT_ORDER_DETAIL_BY_UID" resultType="com.kgitbank.slimbear.admin.dto.OrderListDTO">
 		SELECT m.id AS owner_id, o.*, p.status AS pay_status, p.pay_pg AS pay_pg, p.type AS pay_type, p.price AS pay_amount
		FROM productOrder o LEFT JOIN orderPayment p 
		ON(o.uid=p.order_uid)
		LEFT JOIN member m
		ON(o.mem_uid=m.uid) WHERE o.uid=#{order_uid};
 	</select>
 
 	
 	<select id="SELECT_ORDER_PRODUCTDETAIL_LIST_BY_ORDER_UID" resultType="java.util.HashMap">
 	 	SELECT SUBSTRING_INDEX(op.prod_code,':',1) AS prod_uid, SUBSTRING_INDEX(SUBSTRING_INDEX(op.prod_code,':',2),':',-1) AS color, SUBSTRING_INDEX(SUBSTRING_INDEX(op.prod_code,':',3),':',-1) AS size 
		, op.cnt, op.review_uid, p.*
		FROM orderDetail op LEFT JOIN product p ON(SUBSTRING_INDEX(op.prod_code,':',1) = p.uid)
		WHERE order_uid=#{order_id};
 	</select>
 	
 	
 	<!-- 통계 -->
 	<select id ="SELECT_STATISTICS_MEMBER" resultType="com.kgitbank.slimbear.admin.dto.StatisticsMemberDTO">
	 	SELECT  year(reg_date) as `year`,  
	 	<if test="monthOff == null">
		month(reg_date) as `month`, 
		</if>
	 	month(reg_date) as `month`, 
	 	COUNT(*) as cnt, login_type
		FROM member m
		WHERE 
		<if test="year != null">
		year(reg_date)=#{year} AND 
		</if>
		<if test="month != null">
		month(reg_date)=#{month} AND
		</if>
		1=1
		GROUP BY year(reg_date)
		<if test="monthOff == null">
		,month(reg_date)
		</if>
		<if test="login_type != null">
		,login_type
		</if>
 	</select>
 	
 	<select id="SELECT_STATISTICS_ORDER" resultType="com.kgitbank.slimbear.admin.dto.StatisticsOrderDTO" >
		SELECT year(order_date) as `year`,  month(order_date) as `month`, COUNT(*) as cnt, SUM(op.price) as pay_amount  
		From productOrder p LEFT JOIN orderPayment op
		ON(p.uid = op.order_uid)
		WHERE 
		<if test="year != null">
		year(order_date)=#{year} AND 
		</if>
		<if test="month != null">
		month(order_date)=#{month} AND
		</if>
		<if test="status != null">
		p.`status`= #{status} AND
		</if>
		1=1
		GROUP BY year(order_date), month(order_date);
	</select>
 	
 	<select id="SELECT_STATISTICS_ORDERCNT_PRODUCT_CATEGORY" resultType="com.kgitbank.slimbear.admin.dto.StatisticsCategoryDTO" >
	 	SELECT aa.* , c.name
		FROM
		(SELECT year(oduid.order_date) as year, month(oduid.order_date) as month, pt.ctg_uid, SUM(oduid.cnt) as cnt FROM
		(SELECT SUBSTRING_INDEX(od.prod_code, ':', 1) as prod_uid, od.cnt, p.order_date
		From orderDetail od LEFT JOIN productOrder p
		ON(p.uid = od.order_uid)
		WHERE p.`status`='DONE') as oduid
		LEFT JOIN product pt
		ON(oduid.prod_uid=pt.uid)
		WHERE
		<if test="year != null">
		year(oduid.order_date)=#{year} AND 
		</if>
		<if test="month != null">
		month(oduid.order_date)=#{month} AND
		</if>
		1=1
		GROUP BY pt.ctg_uid, year(oduid.order_date), month(oduid.order_date)) as aa
		LEFT JOIN 
		category c
		ON(aa.ctg_uid=c.uid);
 	</select>
 </mapper>