<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">

<title>기본 페이지 복사해서 써</title>
<style>
    .btn-group > .btn.active {
        background-color: #336699 !important;
        color: #fff;
    }
</style><!-- Custom fonts for this template -->
<link href="/admin/resources/vendor/fontawesome-free/css/all.min.css"
	rel="stylesheet" type="text/css">
<link
	href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
	rel="stylesheet">

<!-- Custom styles for this template -->
<link href="/admin/resources/css/sb-admin-2.css" rel="stylesheet">

<!-- Custom styles for this page -->
<link href="/admin/resources/vendor/datatables/dataTables.bootstrap4.min.css"
	rel="stylesheet">

<!-- Bootstrap core JavaScript-->
<script src="/admin/resources/vendor/jquery/jquery.min.js"></script>
<script src="/admin/resources/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/admin/resources/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/admin/resources/js/sb-admin-2.min.js"></script>

<link
	href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"
	rel="stylesheet">

<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table-locale-all.min.js"></script>

<!-- Export -->
<script
	src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/tableExport.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF/jspdf.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF-AutoTable/jspdf.plugin.autotable.js"></script>
<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/extensions/export/bootstrap-table-export.min.js"></script>

<!-- toolbar -->
<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/extensions/toolbar/bootstrap-table-toolbar.min.js"></script>

</head>

<body id="page-top">

	<!-- Page Wrapper -->
	<div id="wrapper">

		<!-- Sidebar -->
		<th:block th:include="common/leftSlider.html" />

		<!-- Content Wrapper -->
		<div id="content-wrapper" class="d-flex flex-column">

			<!-- Main Content -->
			<div id="content">
				<div class="card shadow mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 font-weight-bold text-primary">게시글관리 -> 공지관리</h6>
					</div>
					<div id="addNoticeFormContainer"
						style="padding-top: 20px; padding-left: 20px; padding-bottom: 20px;">
						<button class="btn btn-primary" onclick="showAddNoticeForm()">새
							공지사항 등록</button>
					</div>
					<div class="card-body">

						<div id="toolbar"></div>

						<table id="table" data-locale="ko-KR" data-search="true"
							data-advanced-search="true" data-id-table="advancedTable"
							data-detail-view="true" data-pagination="true"
							data-show-export="true" data-show-columns="true"
							data-show-columns-toggle-all="true"
							data-page-list="[10, 25, 50, 100, all]"
							data-url="/admin/notice/list">
							<thead>
								<tr>
									<th data-field="uid" data-sortable="true" data-width="1">UID</th>
									<th data-field="title" data-sortable="true" data-width="1">제목</th>
									<th data-field="content" data-sortable="true">내용</th>

									<th data-field="main_image" data-formatter="imageFormatter" data-width="1">사진</th>

									<th data-field="priority" data-sortable="true" data-width="1">우선순위</th>

									<th data-field="view_cnt" data-sortable="true" data-width="1">조회수</th>
									<th data-field="reg_date" data-sortable="true"
										data-formatter="dateFormatter" data-width="10">작성 일자</th>



									<th data-field="select" data-checkbox="true"></th>
									<th data-field="actions" data-formatter="actionsFormatter"
										data-width="1" data-events="actionsEvents">숨김/삭제</th>
								</tr>
							</thead>

						</table>
					</div>
				</div>
			</div>
			<!-- End of Main Content -->
		</div>

		<!-- End of Content Wrapper -->
	</div>
	<!-- Footer -->
	<div>
		<footer class="sticky-footer bg-white">
			<div class="container my-auto">
				<div class="copyright text-center my-auto">
					<span>Copyright &copy; Your Website 2020</span>
				</div>
			</div>
		</footer>
	</div>
	<!-- End of Footer -->

	<!-- Scroll to Top Button-->
	<a class="scroll-to-top rounded" href="#page-top"> <i
		class="fas fa-angle-up"></i>
	</a>

	<!-- Logout Modal-->
	<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
					<button class="close" type="button" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div class="modal-body">Select "Logout" below if you are ready
					to end your current session.</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" type="button"
						data-dismiss="modal">Cancel</button>
					<a class="btn btn-primary" href="login.html">Logout</a>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">큰 이미지</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img src="" alt="큰 이미지" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

	<!-- 리뷰 목록을 펼쳤을 때 표시되는 영역 -->
	<div id="detail-wrapper"></div>

	<script>
    var lastOpenedRow = null;
    
    function showAddNoticeForm() {
        var html = [];
        html.push('<div class="add-notice-form">');
        html.push('<div class="mb-3"><label for="addNoticeTitle" class="form-label">제목</label><input type="text" class="form-control" id="addNoticeTitle"></div>');
        html.push('<div class="mb-3"><label for="addNoticeContent" class="form-label">내용</label><textarea class="form-control" id="addNoticeContent" rows="3"></textarea></div>');

        // 우선순위 드롭다운 메뉴
        html.push('<div class="mb-3"><label for="addNoticePriority" class="form-label">우선순위</label>');
        html.push('<select class="form-select" id="addNoticePriority">');
        html.push('<option value="1">1</option>');
        html.push('<option value="2">2</option>');
        html.push('</select></div>');

        // 타입 드롭다운 메뉴
        html.push('<div class="mb-3"><label for="addNoticeType" class="form-label">타입</label>');
        html.push('<select class="form-select" id="addNoticeType">');
        html.push('<option value="PRODUCT">PRODUCT</option>');
        html.push('<option value="DELIVERY">DELIVERY</option>');
        html.push('<option value="DELIVERY_C">DELIVERY_C</option>');
        html.push('</select></div>');

        
        html.push('<div class="mb-4 d-flex justify-content-left">');
        html.push('    <img id="selectedImage" src="https://mdbootstrap.com/img/Photos/Others/placeholder.jpg" alt="example placeholder" style="width: 300px;" />');
        html.push('</div>');


        html.push('<div class="d-flex justify-content-left">');
        html.push('    <div class="btn btn-primary btn-rounded">');
        html.push('        <label class="form-label text-white m-1" for="customFile1">이미지추가</label>');
        html.push('        <input type="file" class="form-control d-none" name="main_image" id="customFile1" onchange="displaySelectedImage(event, \'selectedImage\')" />');
        html.push('    </div>');
        html.push('</div >');
        html.push('<div style="padding-top:10px;">' );
        html.push('<button type="button" class="btn btn-primary"  onclick="submitAddNoticeForm()">등록</button>');

        html.push('<button type="button" class="btn btn-secondary" onclick="closeAddNoticeForm()">닫기</button>');
        html.push('</div>');
        html.push('</div>');
        $('#addNoticeFormContainer').html(html.join(''));
    }


    

    $(function () {
        // 테이블 초기화
        $('#table').bootstrapTable({
            formatSearch: function () {
                return '모든 항목 검색'
            },
            exportDataType: 'all',
            exportTypes: ['json', 'xml', 'csv', 'pdf'],
            exportOptions: {
                fileName: function () {
                    var cd = new Date().toLocaleDateString().replace(/\./g, '').replace(/\s/g, '');
                    return 'OrderTable_' + cd;
                }
            }
        });

     // 리뷰 목록의 각 행을 클릭했을 때 실행되는 이벤트
     // 리뷰 목록의 각 행을 클릭했을 때 실행되는 이벤트
        $('#table').on('expand-row.bs.table', function (e, index, row, $detail) {
            // 이전에 열린 답글 입력 창이 있다면 닫기
            if (lastOpenedRow != null && lastOpenedRow !== index) {
                $('#table').bootstrapTable('collapseRow', lastOpenedRow);
            }

            $detail.html('상세 정보 불러오는 중....');
            $.ajax({
                url: "/admin/notice/getNotice?uid=" + row['uid'],
                type: "GET",
                success: function (result) {
                    var html = [];
                    html.push('<tbody>');

                    if (result) {
                        var notice = result;
                        html.push('<tr>');
                        html.push('<td>제목: ' + notice.title + '</td>');
                        html.push('</tr>');
                        html.push('<tr>');
                        html.push('<td>내용: ' + notice.content + '</td>');
                        html.push('</tr>');
                        // 기타 필요한 정보들을 추가로 표시
                    }

                    html.push('</tbody></table></div>');

                 // 수정 폼
                    html.push('<div class="edit-notice-form">');
                    html.push('<form id="editNoticeForm">');
                    html.push('<div class="mb-3">');
                    html.push('<label for="editNoticeTitle" class="form-label">제목</label>');
                    html.push('<input type="text" class="form-control" id="editNoticeTitle" value="' + notice.title + '">');
                    html.push('</div>');
                    html.push('<div class="mb-3">');
                    html.push('<label for="editNoticeContent" class="form-label">내용</label>');
                    html.push('<textarea class="form-control" id="editNoticeContent" rows="3">' + notice.content + '</textarea>');
                    html.push('</div>');

                    html.push('<div class="mb-3"><label for="editNoticePriority" class="form-label">우선순위</label>');
                    html.push('<input type="text" class="form-control" id="editNoticePriority" value="' + notice.priority + '"></div>');

                    html.push('<div class="mb-3"><label for="editNoticeType" class="form-label">타입</label>');
                    html.push('<input type="text" class="form-control" id="editNoticeType" value="' + notice.type + '"></div>');

                    html.push('<div class="mb-3">');
                    html.push('<label for="editNoticeMainImage" class="form-label">기존 이미지</label>');
                    html.push('<a href="#" data-toggle="modal" data-target="#imageModal" data-image-url="https://slimbearbucket.s3.ap-northeast-2.amazonaws.com/images/' + notice.main_image + '">' +
                              '<img src="https://slimbearbucket.s3.ap-northeast-2.amazonaws.com/images/' + notice.main_image + '" alt="기존 이미지" style="width: 300px;"></a>');
                    html.push('</div>');


                    
                    html.push('<div class="mb-4 d-flex justify-content-left">');
                    html.push('    <img id="selectedImage" src="https://mdbootstrap.com/img/Photos/Others/placeholder.jpg" alt="example placeholder" style="width: 300px;" />');
                    html.push('</div>');


                    html.push('<div class="d-flex justify-content-left" style="padding-top: 10px;">');
                    html.push('    <div class="btn btn-primary rounded">');
                    html.push('        <label class="form-label text-white m-1" for="customFile1">이미지추가</label>');
                    html.push('        <input type="file" class="form-control d-none" name="main_image" id="customFile1" onchange="displaySelectedImage(event, \'selectedImage\')" />');
                    html.push('    </div>');
                    html.push('</div>');


                    html.push('<div style="padding-top:10px">');
                    html.push('<button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="submitEditNoticeForm(' + notice.uid + ')">수정</button>');

                    html.push('</div>');
                    html.push('</form>');

                    html.push('</div>');

                    $detail.html(html);


                    // 현재 열린 행을 저장
                    lastOpenedRow = index;

                    // 열린 행의 수정 폼에서 '닫기' 버튼을 눌렀을 때의 이벤트 처리
                    $('#table').on('collapse-row.bs.table', function (e, index) {
                        if (lastOpenedRow === index) {
                            lastOpenedRow = null;
                        }
                    });

                   
                },
                error: function () {
                    alert("에러 발생");
                }
            });
        });

    });

    
    // 리뷰 작성 일자를 포맷하는 함수
    function dateFormatter(value, row, index) {
        return [new Date(value).toLocaleDateString().replace(/\./g, '').replace(/\s/g, '-')].join('');
    }

    function ownerFormatter(value, row, index) {
        if (value == null)
            return ['-'].join('');
        else
            return ['<a class="btn btn-primary" href="/admin/home/member?memberID=', value, '">', value, '</a>'].join('')
    }

    function commentsFormatter(value, row, index) {
        if (value === 'SUCCESS') {
            return '<span class="badge badge-success">답변완료</span>';
        } else {
            return '<span class="badge badge-secondary">답변 미등록</span>';
        }
    }

    function actionsFormatter(value, row, index) {
        return [
            '<div class="btn-group" role="group">',
            '<button class="btn btn-dark btn-sm" onclick="hideRow(' + index + ')">Hide</button>',
            '<button class="btn btn-danger btn-sm" onclick="deleteRow(' + index + ')">Delete</button>',
            '</div>'
        ].join('');
    }
    
    function imageFormatter(value, row, index) {
        // Assuming the image fields are named image1, image2, image3, and image4
        return '<a href="#" data-toggle="modal" data-target="#imageModal" data-image-url="https://slimbearbucket.s3.ap-northeast-2.amazonaws.com/images/' + value + '">' +
               '<img src="https://slimbearbucket.s3.ap-northeast-2.amazonaws.com/images/' + value + '" alt="사진" width="100" height="100"></a>';
    }

    $(document).on('click', '[data-toggle="modal"]', function() {
        var imageUrl = $(this).data('image-url');
        $('#imageModal').find('.modal-body img').attr('src', imageUrl);
    });

    function actionsEvents() {
        return {
            'click .btn-primary': function (e, value, row, index) {
                hideRow(index);
            },
            'click .btn-danger': function (e, value, row, index) {
                deleteRow(index);
            }
        };
    }

    function deleteRow(index) {
        var rowData = $('#table').bootstrapTable('getData')[index];

        // 확인을 위해 데이터 출력
        console.log('Data to be sent to the server:', rowData);
        console.log('Index of the row:', index);

        // 삭제 작업을 위한 확인 메시지 등을 표시하고 사용자가 확인하면 서버로 데이터 삭제 요청 전송
        if (confirm('삭제하시겠습니까?')) {
            $.ajax({
                url: '/admin/notice/deleteData',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify(rowData),
                success: function (response) {
                    // 성공적으로 처리된 경우
                    alert('삭제가 완료되었습니다.');
                    // 테이블에서 해당 행을 제거하거나, 다시 불러와서 업데이트 등의 작업 수행
                },
                error: function (error) {
                    // 오류 발생 시
                    alert('삭제 중 오류가 발생했습니다.');
                }
            });
        }
    }
    
 // "새로운 공지사항 등록" 버튼 클릭 시 동적으로 입력 폼 생성 및 표시
//     $('#customToolbar').on('click', '.btn-primary', function () {
//         // 생성할 폼의 HTML 코드
//         var addNoticeFormHtml = `
//             <div class="add-notice-form">
//         	html.push('<div class="add-notice-form">');
//             html.push('<div class="mb-3"><label for="addNoticeTitle" class="form-label">제목</label><input type="text" class="form-control" id="addNoticeTitle"></div>');
//             html.push('<div class="mb-3"><label for="addNoticeContent" class="form-label">내용</label><textarea class="form-control" id="addNoticeContent" rows="3"></textarea></div>');
//             html.push('<div class="mb-3"><label for="addNoticePriority" class="form-label">우선순위</label><input type="number" class="form-control" id="addNoticePriority"></div>');
//             html.push('<div class="mb-3"><label for="addNoticeType" class="form-label">타입</label><input type="text" class="form-control" id="addNoticeType"></div>');
//             html.push('<div class="mb-3"><label for="addNoticeMainImage" class="form-label">이미지 URL</label><input type="text" class="form-control" id="addNoticeMainImage"></div>');
//                 <button type="button" class="btn btn-primary" onclick="submitAddNoticeForm()">등록</button>
//                 <button type="button" class="btn btn-secondary" onclick="closeAddNoticeForm()">닫기</button>
//             </div>
//         `;

//         // 생성한 폼을 컨테이너에 추가하고 표시
//         $('#addNoticeFormContainer').html(addNoticeFormHtml);
//     });

    // "등록" 버튼 클릭 시 폼 제출 (실제 동작에 맞게 수정 필요)
    function submitAddNoticeForm() {
    var title = $('#addNoticeTitle').val();
    var content = $('#addNoticeContent').val();
    var priority = $('#addNoticePriority').val();
    var type = $('#addNoticeType').val();

    // FormData 객체 생성
    var formData = new FormData();
    formData.append('title', title);
    formData.append('content', content);
    formData.append('priority', priority);
    formData.append('type', type);

    // 파일 필드 추가
    var mainImageInput = $('#customFile1')[0].files[0];
    formData.append('mainImage', mainImageInput);

    // Ajax 요청
    $.ajax({
        url: "/admin/notice/addNotice",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (result) {
            if (result.status === 'SUCCESS') {
                alert(result.message);
                closeAddNoticeForm();
            } else {
                alert('새 공지사항 등록에 실패했습니다.');
            }
        },
        error: function () {
            alert("서버 오류로 인해 새 공지사항을 등록할 수 없습니다.");
        }
    });
}
 // "닫기" 버튼 클릭 시 폼 닫기
    function closeAddNoticeForm() {
        $('#addNoticeFormContainer').html(''); // 폼을 닫음

        // "새 공지사항 등록" 버튼을 다시 생성
        var addButtonHtml = '<button class="btn btn-primary" onclick="showAddNoticeForm()">새 공지사항 등록</button>';
        $('#addNoticeFormContainer').html(addButtonHtml);
    }
 
 // 수정 폼 닫기 함수
    function closeEditNoticeForm() {
        $('#table').bootstrapTable('collapseRow', lastOpenedRow);
        lastOpenedRow = null;
    }
 
 // 공지 수정
    function submitEditNoticeForm(uid) {
        var title = $('#editNoticeTitle').val();
        var content = $('#editNoticeContent').val();
        var priority = $('#editNoticePriority').val();
        var type = $('#editNoticeType').val();

        // FormData 객체 생성
        var formData = new FormData();
        formData.append('uid', uid);
        formData.append('title', title);
        formData.append('content', content);
        formData.append('priority', priority);
        formData.append('type', type);

        // 파일 필드 추가
        var mainImageInput = $('#customFile1')[0].files[0];
        formData.append('main_image', mainImageInput);

        // Ajax 요청
        $.ajax({
            url: "/admin/notice/editNotice",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (result) {
                if (result.status === 'SUCCESS') {
                    alert(result.message);
                    closeEditNoticeForm();
                    // TODO: 성공에 따른 추가적인 동작 수행
                } else {
                    alert(result.message);
                }
            },
            error: function () {
                alert("서버 오류로 인해 공지사항을 수정할 수 없습니다.");
            }
        });
    }

 
    function displaySelectedImage(event, elementId) {
        const selectedImage = document.getElementById(elementId);
        const fileInput = event.target;

        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();

            reader.onload = function(e) {
                selectedImage.src = e.target.result;
            };

            reader.readAsDataURL(fileInput.files[0]);
        }
    }
</script>

</html>