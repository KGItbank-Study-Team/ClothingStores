<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">

<title>기본 페이지 복사해서 써</title>

<!-- Custom fonts for this template -->
<link href="/admin/vendor/fontawesome-free/css/all.min.css"
	rel="stylesheet" type="text/css">
<link
	href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
	rel="stylesheet">

<!-- Custom styles for this template -->
<link href="/admin/css/sb-admin-2.css" rel="stylesheet">

<!-- Custom styles for this page -->
<link href="/admin/vendor/datatables/dataTables.bootstrap4.min.css"
	rel="stylesheet">

<!-- Bootstrap core JavaScript-->
<script src="/admin/vendor/jquery/jquery.min.js"></script>
<script src="/admin/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/admin/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/admin/js/sb-admin-2.min.js"></script>

<link
	href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"
	rel="stylesheet">

<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table-locale-all.min.js"></script>

<!-- Export -->
<script
	src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/tableExport.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF/jspdf.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF-AutoTable/jspdf.plugin.autotable.js"></script>
<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/extensions/export/bootstrap-table-export.min.js"></script>

<!-- toolbar -->
<script
	src="https://unpkg.com/bootstrap-table@1.22.1/dist/extensions/toolbar/bootstrap-table-toolbar.min.js"></script>

</head>

<body id="page-top">

	<!-- Page Wrapper -->
	<div id="wrapper">

		<!-- Sidebar -->
		<th:block th:include="common/leftSlider.html" />

		<!-- Content Wrapper -->
		<div id="content-wrapper" class="d-flex flex-column">

			<!-- Main Content -->
			<div id="content">
				<div class="card shadow mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 font-weight-bold text-primary">게시글관리 -> 리뷰관리</h6>
					</div>
					<div class="card-body">

						<div id="toolbar"></div>

						<table id="table" data-locale="ko-KR" data-search="true"
							data-advanced-search="true" data-id-table="advancedTable"
							data-detail-view="true" data-pagination="true"
							data-show-export="true" data-show-columns="true"
							data-show-columns-toggle-all="true"
							data-page-list="[10, 25, 50, 100, all]"
							data-url="/admin/review/list">
							<thead>
								<tr>
									<th data-field="uid" data-sortable="true" data-width="23">ReviewUID</th>
									<th data-field="mem_id" data-sortable="true" data-width="180"
										data-formatter="ownerFormatter">아이디</th>
									<th data-field="prod_code" data-sortable="true"
										data-width="25">상품코드</th>
									<th data-field="title" data-sortable="true" data-width="180">제목</th>
									<th data-field="content" data-sortable="true" >내용</th>
									<th data-field="status" data-width="50" data-sortable="true" data-formatter="commentsFormatter">답글여부</th>

									<th data-field="score" data-sortable="true"data-width="10">평점</th>
									<th data-field="reg_date" data-sortable="true"
										data-formatter="dateFormatter" data-width="120">작성 일자</th>
								</tr>
							</thead>

						</table>
					</div>
				</div>
			</div>
			<!-- End of Main Content -->
		</div>
		<!-- End of Content Wrapper -->
</div>
		<!-- Footer -->
		<div>
			<footer class="sticky-footer bg-white">
				<div class="container my-auto">
					<div class="copyright text-center my-auto">
						<span>Copyright &copy; Your Website 2020</span>
					</div>
				</div>
			</footer>
		</div>
		<!-- End of Footer -->

		<!-- Scroll to Top Button-->
		<a class="scroll-to-top rounded" href="#page-top"> <i
			class="fas fa-angle-up"></i>
		</a>

		<!-- Logout Modal-->
		<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
						<button class="close" type="button" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
					</div>
					<div class="modal-body">Select "Logout" below if you are ready
						to end your current session.</div>
					<div class="modal-footer">
						<button class="btn btn-secondary" type="button"
							data-dismiss="modal">Cancel</button>
						<a class="btn btn-primary" href="login.html">Logout</a>
					</div>
				</div>
			</div>
		</div>

		<!-- 리뷰 목록을 펼쳤을 때 표시되는 영역 -->
		<div id="detail-wrapper"></div>

		<script>
			var lastOpenedRow = null;
			$(function() {
				// 테이블 초기화
				$('#table').bootstrapTable({
					formatSearch : function() {
						return '모든 항목 검색'
					},
					exportDataType : 'all',
					exportTypes : [ 'json', 'xml', 'csv', 'pdf' ],
					exportOptions : {
						fileName : function() {
							var cd = new Date().toLocaleDateString().replace(
									/\./g, '').replace(/\s/g, '');
							return 'OrderTable_' + cd;
						}
					}
				});

				// 리뷰 목록의 각 행을 클릭했을 때 실행되는 이벤트
				$('#table').on('expand-row.bs.table', function (e, index, row, $detail) {
					// 이전에 열린 답글 입력 창이 있다면 닫기
		            if (lastOpenedRow != null && lastOpenedRow !== index) {
		                $('#table').bootstrapTable('collapseRow', lastOpenedRow);
		            }
					$detail.html('상세 정보 불러오는 중....');
				    $.ajax({
				        url: "/admin/review/getComment?reviewUID=" + row['uid'],
				        type: "GET",
				        success: function (result) {
				            var html = [];
				            html.push('<tbody>');

				            if (result) {
				                var comment = result;
				                html.push('<tr>');
				                html.push('<td>' + (result.status === 'SUCCESS' ? '답변완료' : '미등록') + '</td>');

				               
				                html.push('</tr>');
				            }

				            html.push('</tbody></table></div>');

							 // 답글 작성 폼
						    html.push('<div class="reply-form">');
						    html.push('<form id="replyForm">');
							html.push('<div class="mb-3">')
						    html.push('<label for="mem_id" class="form-label">작성자 ID</label>')
						    html.push('<input type="text" class="form-control dark-input" id="mem_id" value="' + row['mem_id'] + '" readonly>')
						            
						            
						    html.push('</div>')
						    html.push('<div class="mb-3">');
						    html.push('<label for="commentTitle" class="form-label">제목</label>');
						    html.push('<input type="text" class="form-control" id="commentTitle">');
						    html.push('</div>');
						    html.push('<div class="mb-3">');
						    html.push('<label for="commentContent" class="form-label">내용</label>');
						    html.push('<textarea class="form-control" id="commentContent" rows="3"></textarea>');
						    html.push('</div>');
						   
						    html.push('<button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="addOrUpdateComment(' + row['uid'] + ')">답글 추가/수정</button>');
						    html.push('</form>');
						    html.push('</div>');

						    $detail.html(html);

							// 답글이 있는 경우, 답글 내용을 폼에 채워줌
						    if (result) {
    							$('#commentTitle').val(result.title);
    							$('#commentContent').val(result.content);
							}
						 // 현재 열린 행을 저장
		                    lastOpenedRow = index;
		                    
		                    // 열린 행의 답글 작성 폼에서 '닫기' 버튼을 눌렀을 때의 이벤트 처리
		                    $('#table').on('collapse-row.bs.table', function (e, index) {
		                        if (lastOpenedRow === index) {
		                            lastOpenedRow = null;
		                        }
		                    });
						},
						error : function() {
							alert("error");
						}
					});
				});
			});

	// 리뷰 작성 일자를 포맷하는 함수
	function dateFormatter(value, row, index) {
		return [ new Date(value).toLocaleDateString().replace(/\./g, '')
				.replace(/\s/g, '-') ].join('');
	}

	// 리뷰 답글을 추가 또는 수정하는 함수
	function addOrUpdateComment(uid) {
		var commentTitle = $('#commentTitle').val();
		var commentContent = $('#commentContent').val();
		var mem_id = $('#mem_id').val();
		// 서버로 답글 데이터를 전송하고 저장하는 AJAX 요청
		$.ajax({
			url : '/admin/review/addOrUpdateComment',
			type : 'POST',
			data : {
				reviewUID : uid,
				commentTitle : commentTitle,
				commentContent : commentContent,
				mem_id : mem_id
			},
			success : function(result) {
				// 성공적으로 답글을 추가 또는 수정한 경우, 여기에서 추가한 답글을 화면에 표시하거나 업데이트할 수 있습니다.
				// 필요한 경우, 서버로부터 가져온 데이터를 이용하여 답글을 동적으로 생성하여 $replyList에 추가합니다.
				// 답글 목록을 표시하는 부분은 위에서 생성한 $replyList를 활용합니다.
				// 이후 필요한 작업을 수행하세요.
				alert('답글이 성공적으로 추가/수정되었습니다.');
			},
			error : function() {
				alert('Error adding/updating reply');
			}
		});
	}
	function ownerFormatter(value, row, index){
		if(value == null)
			return ['-'].join('');
		else
			return [ 
				'<a class="btn btn-primary" href="/admin/home/member?memberID=',value,'">',value,'</a>'
			].join('')
	}
	function commentsFormatter(value, row, index) {
        if (value === 'SUCCESS') {
            return '<span class="badge badge-success">답변완료</span>';
        } else {
            return '<span class="badge badge-secondary">답변 미등록</span>';
        }
    }
	
</script>
</html>